# #47: KAPE - Task1-Task6

An introduction to Kroll Artifact Parser and Extractor (KAPE) for collecting and processing forensic artifacts.

Room link: https://tryhackme.com/room/kape

## **Learning Objectives:**

- Learn about KAPE
- How KAPE works
- The different targets and modules used by KAPE
- Collection and analysis of forensic data using KAPE

# Task 2: Introduction to KAPE

![0f176a6a5c43d74479af82aa386d0664.png](0f176a6a5c43d74479af82aa386d0664.png)

### Introduction to KAPE (Kroll Artifact Parser and Extractor)

**Overview**

- **Purpose**: Extracts and parses Windows forensic artifacts to speed up incident response by collecting data from live systems or storage devices before imaging completes.
- **Functions**:
    - Collects forensic artifacts (targets).
    - Processes collected artifacts using modules to extract information.

**How KAPE Works**

![d1489a8062d714fa227dd3382dfd15d1.png](d1489a8062d714fa227dd3382dfd15d1.png)

- **Extensibility**: Highly configurable, uses targets (artifacts to collect) and modules (programs to process artifacts).
- **File Collection Process**:
    - **First Pass**: Copies unlocked files to a queue.
    - **Second Pass**: Uses raw disk reads to bypass OS locks for remaining files.
    - Preserves original timestamps, metadata, and directory structure.
- **Processing**: Modules (e.g., Prefetch Parser, PECmd) process collected files (e.g., Prefetch files) and output data (e.g., CSV format).
- **Sources**: Collects from live systems, mounted images, or F-response utility.

**Key Features**

- Portable, no installation needed; runs from network locations or USB drives.
- Supports CLI (`kape.exe`) and GUI (`gkape.exe`) versions.

**Setup in VM**

- **Access**: Start the VM (top-right Start Machine button) or log in with:
    - Username: `thm-4n6`
    - Password: `123`
- **Location**: KAPE folder on Desktop contains:
    
    ![e56dffdd3de51e8dbc5647270901b603.png](e56dffdd3de51e8dbc5647270901b603.png)
    
    - `kape.exe`: CLI version.
    - `gkape.exe`: GUI version.
    - `gkape.settings`: GUI default settings.
    - `Get-KAPEUpdate.ps1`: PowerShell script for updates.
    - `ChangeLog.txt` and `Documentation`: Self-explanatory.

### 1. From amongst kape.exe and gkape.exe, which binary is used to run GUI version of KAPE?

- `gkape.exe`

# Task 3: Target Options

**Targets**

![3902f2f2088969b01e9672553f48c9e4.png](3902f2f2088969b01e9672553f48c9e4.png)

- **Definition**: Artifacts (e.g., files) collected from a system or image and copied to a specified destination.
- **Examples**: Windows Prefetch (evidence of execution), registry hives.
- **Location**: Found in KAPE’s `Targets` directory, organized into subdirectories (e.g., `Windows`).
- **File Format**: Defined in `.tkape` files, specifying artifact details like path, category, and file masks.
    - **Example**: Prefetch Target collects `.pf` files from `C:\Windows\prefetch` and `C:\Windows.old\prefetch` (historical artifacts post-Windows update).
        
        ![92dce7807d9ea37f6f5e1e62f271275b.png](92dce7807d9ea37f6f5e1e62f271275b.png)
        
- **Guides/Templates**: Last four files in `Targets` directory assist in creating custom Targets and Compound Targets.
    
    ![20d9d19240bcaeb95b55ad2efb105c1c.png](20d9d19240bcaeb95b55ad2efb105c1c.png)
    

**Compound Targets**

- **Definition**: Combine multiple Targets into a single collection command for efficient triage.
- **Examples**: `!BasicCollection`, `!SANS_triage`, `KAPEtriage`.
- **Location**: `KAPE\\Targets\\Compound`.
- **Example**: A Compound Target for execution evidence collects from Prefetch, RecentFileCache, AmCache, and Syscache.
    
    ![76260284a8d68c7d38126a7237e9c16a.png](76260284a8d68c7d38126a7237e9c16a.png)
    
- **Purpose**: Speeds up data collection by avoiding individual artifact collection.

**Special Directories**

- **!Disabled**: Stores Targets to keep in KAPE but exclude from the active Targets list.
- **!Local**: Holds custom Targets not synced with KAPE’s GitHub repository or specific to your environment. Non-GitHub Targets are moved here during updates.

---

### Key Answers:

- **3.1 – File extension for Targets:** `.tkape`
- **3.2 – To collect multiple artifacts with one command:** **Compound Target**

---

# Task 4 – Module Options

### KAPE Modules

**Overview**

- **Definition**: Modules in KAPE execute specific tools on collected files to process data and generate outputs, typically in CSV or TXT format, rather than copying files.
- **Location**: Found in KAPE’s `Modules` directory, organized similarly to the Targets directory.

**Modules Directory Structure**

![e4dbd842fa5b548ac8fade7b94ab0c8a.png](e4dbd842fa5b548ac8fade7b94ab0c8a.png)

- **Contents**: Includes guides/templates for creating Modules and Compound Modules, plus `!Disabled`, `!Local`, and `Compound` directories (same as Targets, not discussed here).
- **Windows Directory**: Contains `.mkape` files defining Modules.
    - **Example**: The `Windows_IPConfig.mkape` file (image below) specifies the executable to run, command-line parameters, output format, and export filename.
        
        ![9a9760a2f1004e74b23294681f7bfdef.png](9a9760a2f1004e74b23294681f7bfdef.png)
        

**The bin Directory**

![a3547f25552d5d440d4f85022b53bc01.png](a3547f25552d5d440d4f85022b53bc01.png)

- **Purpose**: Stores executables not natively present on most systems, which KAPE uses for processing.
- **Examples**: Includes tools like Eric Zimmerman’s utilities (used in Windows Forensics rooms).
- **Execution**: KAPE runs executables from the `bin` directory or a specified full path.
    
    ![15bfb563be1d5bf1e988ab3e7486b58e.png](15bfb563be1d5bf1e988ab3e7486b58e.png)
    

---

### Key Answers:

- **4.1 – File extension for Modules:** `.mkape`
- **4.2 – Directory containing required binaries:** `bin`

---

# Task 5 – KAPE GUI

---

Now that we have learned about the different components of KAPE let's take it for a test drive. In the attached VM, double-click to open the gkape.exe file. You will see the following Window:

 Steps I Followed:

1. I opened **gkape.exe** from the attached VM.
    
    ![6af6adcb6ce48c0dd32aec787206e20d.png](6af6adcb6ce48c0dd32aec787206e20d.png)
    
2. I enabled the **Use Target Options** checkbox to activate the left panel.
    
    ![5e9c5d0148cf664325c8a075-1719406320965.webp](5e9c5d0148cf664325c8a075-1719406320965.webp)
    
3. For live forensic collection, I set:
    - **Target Source:** `C:\`
        
        ![f4a865927aef7b0fa4668f13ef8f9cfa.png](f4a865927aef7b0fa4668f13ef8f9cfa.png)
        
    - **Target Destination:** My preferred output directory
4. I left **Flush** to unchecked later (to avoid deleting existing data).
5. I explored additional options:
    - **Add %d:** Appends **date/time** to the triage folder name
    - **Add %m:** Appends **machine info** to the folder name
6. I also learned:
    - **Process VSCs:** Includes Volume Shadow Copies
    - **Transfer checkbox:** Enables sending data to an **SFTP** or **S3 bucket**
    - **Container options:** Can package collected data as **ZIP**, **VHD**, or **VHDX**
        
        ![22a7063c7c3bb75bc2ddaede7fcf9f57.png](22a7063c7c3bb75bc2ddaede7fcf9f57.png)
        
7. I checked the **Current Command Line tab** — it auto-generates the CLI equivalent of my GUI selections.
    
    ![fd514feceacfd972097ef26b5ac433ed.png](fd514feceacfd972097ef26b5ac433ed.png)
    
8. Then, I enabled **Use Module Options** to process collected artifacts with analysis tools.
    
    When using both Target and Module Options, providing Module Source is not required. The selected Modules will use the Target destination as the source.
    
    ![811ceeea4083ab70546d89f5ecfc2f6f.png](811ceeea4083ab70546d89f5ecfc2f6f.png)
    
9. The rest of the options for Modules are similar to the ones for Targets, so we won't go into details for them.  
    
    Below you will see what the configuration looks like when we have KAPE all set up for collecting Targets and processing them using Modules.
    
    ![d4e260cbc96fd497859c9133cdb345a8.png](d4e260cbc96fd497859c9133cdb345a8.png)
    
10. I selected:
    - **Target:** `KapeTriage`
    - **Module:** `EZParser`
11. Finally, I clicked **Execute** — KAPE ran in the background and generated categorized results in the output folder.
    
    ![1_g1w59kCbD6Q2NBiulVrGZw.webp](1_g1w59kCbD6Q2NBiulVrGZw.webp)
    

12. Notice that at the backend, KAPE is running the `kape.exe` in a command line. We can check out the files created by KAPE once it completes processing them. The below snapshot shows our `Module destination`. Notice how KAPE has processed the files according to different categories.

![0_6Irqa4omBh2mkO-O.webp](0_6Irqa4omBh2mkO-O.webp)

Let’s collect triage data using the `KAPETriage` package, process it using `!EZParser` module, and answer the questions below. Then we can proceed to learn about the KAPE CLI in the next task.

### Key Answers:

- **5.1 – In the second to last screenshot above, what target have we selected for collection?**
    
    **Target selected:** `KapeTriage`
    
- **5.2 – In the second to last screenshot above, what module have we selected for processing?**
    
    **Module selected:** `EZParser`
    
- **5.3 – What option has to be checked to append date and time information to triage folder name?**
    
    **To append date/time:** `%d`
    
- **5.4 – What option needs to be checked to add machine information to the triage folder name?**
    
    **To append machine info:** `%m`
    

---

# Task 6: KAPE CLI

The Kroll Artifact Parser and Extractor (KAPE) is a powerful command-line tool for Windows forensic analysis, enabling rapid collection and processing of artifacts. This guide explores how to use KAPE via its command-line interface (CLI) to perform triage tasks, leveraging its flexibility to streamline incident response. Whether you're a forensic analyst or incident responder, understanding KAPE’s CLI capabilities is essential for efficient evidence collection and analysis.

## Viewing KAPE CLI Switches

To explore KAPE’s command-line options:

1. Open an elevated PowerShell (Run as Administrator).
2. Navigate to the KAPE binary directory (e.g., `D:\\KAPE`).
3. Run `kape.exe` to display available switches.
    
    ![1_CnXGbPhePgJbM7eQXseUHQ.webp](1_CnXGbPhePgJbM7eQXseUHQ.webp)
    
    ![1_1DdszTUMiQ5CLyVRSZOftA.webp](1_1DdszTUMiQ5CLyVRSZOftA.webp)
    
    ![1_YwQbCCY9kPnkekpYbu_dLw.webp](1_YwQbCCY9kPnkekpYbu_dLw.webp)
    

**Key Switches**:

- **Required for Targets**:
    - `-tsource`: Source drive (e.g., `C:`).
    - `-target`: Target configuration (e.g., `KapeTriage`).
    - `-tdest`: Destination directory for collected files.
- **Required for Modules**:
    - `-module`: Module configuration (e.g., `!EZParser`).
    - `-mdest`: Destination for processed output.
- **Optional Switches**:
    - `-tflush`: Deletes contents of `-tdest` before collection.
    - `-msource`: Module source directory (defaults to `-tdest` if omitted).
    - `-vss`: Processes Volume Shadow Copies.
    - `-vhdx`, `-vhd`, `-zip`: Creates containers for file transfer.
    - `-scs`, `-scp`, `-scu`, `-scpw`, `-scd`: SFTP transfer settings.
    - `-s3p`, `-s3r`, `-s3b`, `-s3k`, `-s3s`: S3 transfer settings.
    - `-hex`: Excludes files by SHA-1 hash.
    - `-debug`, `-trace`: Enable detailed logging.
    - `-gui`: Prevents window closure in GUI mode.
    - `-sync`: Downloads latest Targets/Modules from GitHub.

**Variables**:

- `%d`: Timestamp (yyyyMMddTHHmmss).
- `%s`: System drive letter.
- `%m`: Machine name.

**Example Output**:

- Running `kape.exe` lists all switches, examples, and documentation: [KAPE Documentation](https://ericzimmerman.github.io/KapeDocs/).

## Building a KAPE CLI Command

To replicate the GUI task of collecting triage data with the `KapeTriage` Compound Target and processing it with the `!EZParser` Compound Module, construct the following command:

1. **Start with the binary**:
    
    ```
    kape.exe
    ```
    
2. **Add Target Source**:
    
    ```
    kape.exe --tsource C:
    ```
    
3. **Specify Target and Destination**:
    - Use `-target KapeTriage` for the Compound Target.
    - Set `-tdest C:\\Users\\thm-4n6\\Desktop\\target` (KAPE creates the directory if it doesn’t exist).
    
    ```
    kape.exe --tsource C: --target KapeTriage --tdest C:\\Users\\thm-4n6\\Desktop\\target
    ```
    
4. **Add Module Options**:
    - Use `-mdest C:\\Users\\thm-4n6\\Desktop\\module` for Module output.
    - Specify `-module !EZParser` to process data.
    - Omit `-msource` as it defaults to `-tdest`.
    
    ```
    kape.exe --tsource C: --target KapeTriage --tdest C:\\Users\\thm-4n6\\Desktop\\target --mdest C:\\Users\\thm-4n6\\Desktop\\module --module !EZParser
    ```
    
5. **Run Command**:
    - Execute in an elevated shell (Administrator privileges required).
    - A command-line window displays logs, similar to the GUI task, with collected files and processed outputs saved to the specified directories.

**Optional Modification**:

- Add `-tflush` to clear the `-tdest` directory before collection (use cautiously).

## Batch Mode for Automation

KAPE supports **Batch Mode** to automate multiple commands via a `_kape.cli` file:

- Create `_kape.cli` in the KAPE binary directory.
- Add commands in a single line, e.g.:
    
    ```
    --tsource C: --target KapeTriage --tdest C:\\Users\\thm-4n6\\Desktop\\target --mdest C:\\Users\\thm-4n6\\Desktop\\module --module !EZParser
    ```
    
- Run `kape.exe` as Administrator; it detects and executes `_kape.cli` commands.
- Ideal for delegating tasks to others, requiring only a right-click to run `kape.exe`.

## Task Questions and Answers

Log into the machine and navigate to the `C:\Users\THM-4n6\Desktop\KAPE` folder via an elevated shell and run `kape.exe`

![image.png](image.png)

| **Question** | **Answer** | **Explanation** |
| --- | --- | --- |
| 6.1 What variable adds the collection timestamp to the target destination? | **%d** | Appends date/time info to target folder |
| 6.2 What variable adds the machine information to the target destination? | **%m** | Appends machine name info |
| 6.3 Which switch can be used to show debug information during processing? | **debug** | Enables verbose debug logs |
| 6.4 Which switch is used to list all targets available? | **tlist** | Lists available KAPE target sets |
| 6.5 Which flag, when used with batch mode, deletes `_kape.cli`, targets, and modules files after execution? | **cu** | Cleans up CLI and module files post-run |

---